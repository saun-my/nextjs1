{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 82, "column": 0}, "map": {"version":3,"sources":["file:///Users/saunmy/Desktop/nextjs1/nextjs1/app/api/learning/recommendations/route.ts"],"sourcesContent":["'use server';\n\nimport postgres from 'postgres';\nimport { NextRequest } from 'next/server';\n\nconst sql = postgres(process.env.POSTGRES_URL || process.env.POSTGRES_URL_NON_POOLING!, {\n  ssl: process.env.POSTGRES_SSL === 'require' ? 'require' : undefined,\n});\n\ntype DbCourse = {\n  id: string;\n  title: string;\n  level: string;\n  description: string;\n  cover_url: string | null;\n  lessons_count: number;\n  estimated_hours: number;\n  difficulty_score: number;\n  tags: string[] | null;\n};\n\ntype DbProfile = {\n  user_id: string;\n  preferred_difficulty: number | null;\n  preferred_topics: string[] | null;\n  learning_style: string | null;\n  weekly_goal_hours: number | null;\n  study_time_preference: string | null;\n};\n\ntype DbProgress = {\n  course_id: string;\n  completed_lessons: string[] | null;\n  total_score: number | null;\n  time_spent_minutes: number | null;\n  completion_percentage: number | null;\n  is_completed: boolean | null;\n};\n\nexport async function GET(req: NextRequest) {\n  try {\n    const { searchParams } = new URL(req.url);\n    const userId = searchParams.get('userId') || '';\n    const limitParam = searchParams.get('limit');\n    const limit = limitParam ? Math.max(1, Math.min(20, Number(limitParam))) : 6;\n\n    const courses: DbCourse[] = await sql`\n      SELECT id, title, level, description, cover_url, lessons_count, estimated_hours, difficulty_score, tags\n      FROM courses\n    `;\n\n    let profile: DbProfile | null = null;\n    if (userId) {\n      const rows = await sql<DbProfile[]>`\n        SELECT user_id, preferred_difficulty, preferred_topics, learning_style, weekly_goal_hours, study_time_preference\n        FROM user_learning_profiles WHERE user_id = ${userId}\n      `;\n      profile = rows[0] || null;\n    }\n\n    const progressRows: DbProgress[] = userId\n      ? await sql<DbProgress[]>`\n          SELECT course_id, completed_lessons, total_score, time_spent_minutes, completion_percentage, is_completed\n          FROM user_course_progress WHERE user_id = ${userId}\n        `\n      : [];\n\n    const progressByCourse = new Map<string, DbProgress>();\n    for (const p of progressRows) progressByCourse.set(p.course_id, p);\n\n    const preferredDifficulty = profile?.preferred_difficulty ?? 5;\n    const preferredTopics = profile?.preferred_topics ?? [];\n    const learningStyle = profile?.learning_style ?? 'interactive';\n\n    const recommendations = courses.map((c) => {\n      let score = 50;\n      const diffMatch = 10 - Math.abs((c.difficulty_score ?? 5) - preferredDifficulty);\n      score += diffMatch * 2;\n\n      const tags = c.tags ?? [];\n      const topicMatches = tags.filter((t) => preferredTopics.includes(t)).length;\n      score += topicMatches * 5;\n\n      if (learningStyle === 'interactive' && c.level === 'Beginner') score += 10;\n\n      const prog = progressByCourse.get(c.id);\n      if (prog) {\n        if (prog.is_completed) score = 0;\n        else score += 20;\n      }\n\n      score = Math.min(100, Math.max(0, Math.round(score)));\n      const confidence = Math.min(100, Math.max(70, score));\n\n      return {\n        course: {\n          id: c.id,\n          title: c.title,\n          description: c.description,\n          category: tags[0] || 'General',\n          difficulty: c.level === 'Beginner' ? 'beginner' : c.level === 'Intermediate' ? 'intermediate' : 'advanced',\n          estimatedHours: c.estimated_hours,\n          prerequisites: [],\n          tags,\n          learningObjectives: [],\n          modules: [],\n          rating: 4.6,\n          enrollmentCount: 1000,\n          completionRate: 0.7,\n          lastUpdated: new Date(),\n        },\n        score,\n        reasons: buildReasons(c, preferredTopics, prog),\n        confidence: confidence / 100,\n        estimatedCompletionTime: c.estimated_hours * 60,\n        skillGapAnalysis: [],\n      };\n    })\n      .filter((r) => r.score > 0)\n      .sort((a, b) => b.score - a.score)\n      .slice(0, limit);\n\n    return Response.json({ recommendations, totalCount: recommendations.length, queryTime: 1, hasMore: false });\n  } catch (error) {\n    return Response.json({ error: (error as Error).message }, { status: 500 });\n  }\n}\n\nfunction buildReasons(c: DbCourse, preferredTopics: string[], prog?: DbProgress | undefined): string[] {\n  const reasons: string[] = [];\n  const tags = c.tags ?? [];\n  const match = tags.filter((t) => preferredTopics.includes(t));\n  if (match.length) reasons.push(`匹配你的兴趣：${match.join('、')}`);\n  if (c.level === 'Beginner') reasons.push('适合初学者逐步提升');\n  if (prog && !prog.is_completed) reasons.push('继续你已开始但未完成的课程类别');\n  return reasons.length ? reasons : ['综合匹配度较高'];\n}\n"],"names":[],"mappings":"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","debugId":null}}]
}