{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 82, "column": 0}, "map": {"version":3,"sources":["file:///Users/saunmy/Desktop/nextjs1/nextjs1/app/api/investments/plans/route.ts"],"sourcesContent":["import { NextRequest } from 'next/server';\nimport postgres from 'postgres';\nimport { randomUUID } from 'crypto';\n\nconst sql = postgres(process.env.POSTGRES_URL_NON_POOLING || process.env.POSTGRES_URL!, {\n  ssl: 'require',\n  prepare: false,\n});\n\nasync function ensureSchema() {\n  await sql`\n    CREATE TABLE IF NOT EXISTS investment_plans (\n      id UUID PRIMARY KEY,\n      user_id UUID REFERENCES users(id) ON DELETE CASCADE,\n      fund_code TEXT NOT NULL,\n      amount NUMERIC NOT NULL,\n      frequency TEXT NOT NULL, -- 'weekly' | 'monthly'\n      day_of_week INT, -- 0-6, for weekly\n      day_of_month INT, -- 1-31, for monthly\n      start_date DATE NOT NULL,\n      end_date DATE,\n      next_run DATE NOT NULL,\n      status TEXT NOT NULL DEFAULT 'active', -- 'active' | 'paused'\n      created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()\n    );\n  `;\n}\n\nfunction fmtDate(d: Date) {\n  return new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate())).toISOString().slice(0, 10);\n}\n\nfunction nextWeekly(from: Date, dow: number) {\n  const curDow = from.getUTCDay();\n  const diff = (dow - curDow + 7) % 7;\n  const next = new Date(Date.UTC(from.getUTCFullYear(), from.getUTCMonth(), from.getUTCDate() + diff));\n  return next;\n}\n\nfunction nextMonthly(from: Date, dom: number) {\n  const y = from.getUTCFullYear();\n  const m = from.getUTCMonth();\n  const cur = new Date(Date.UTC(y, m, Math.min(dom, 28))); // avoid overflow for simplicity\n  if (from.getUTCDate() <= dom) return new Date(Date.UTC(y, m, dom));\n  const next = new Date(Date.UTC(y, m + 1, dom));\n  return next;\n}\n\nexport async function GET(req: NextRequest) {\n  await ensureSchema();\n  const { searchParams } = new URL(req.url);\n  const userId = searchParams.get('userId');\n  const rows = userId\n    ? await sql`SELECT * FROM investment_plans WHERE user_id = ${userId} ORDER BY created_at DESC`\n    : await sql`SELECT * FROM investment_plans ORDER BY created_at DESC LIMIT 100`;\n  return Response.json(rows);\n}\n\nexport async function POST(req: NextRequest) {\n  await ensureSchema();\n  const body = await req.json();\n  const { user_id, fund_code, amount, frequency, day_of_week, day_of_month, start_date, end_date } = body;\n  if (!user_id || !fund_code || !amount || !frequency || !start_date) {\n    return Response.json({ error: 'missing fields' }, { status: 400 });\n  }\n  const start = new Date(start_date);\n  let next: Date;\n  if (frequency === 'weekly') {\n    const dow = typeof day_of_week === 'number' ? day_of_week : start.getUTCDay();\n    next = nextWeekly(start, dow);\n  } else if (frequency === 'monthly') {\n    const dom = typeof day_of_month === 'number' ? day_of_month : start.getUTCDate();\n    next = nextMonthly(start, dom);\n  } else {\n    return Response.json({ error: 'invalid frequency' }, { status: 400 });\n  }\n  await sql`\n    INSERT INTO investment_plans (id, user_id, fund_code, amount, frequency, day_of_week, day_of_month, start_date, end_date, next_run, status)\n    VALUES (${randomUUID()}, ${user_id}, ${fund_code}, ${Number(amount)}, ${frequency}, ${day_of_week ?? null}, ${day_of_month ?? null}, ${start}, ${end_date ? new Date(end_date) : null}, ${fmtDate(next)}, ${'active'})\n  `;\n  return Response.json({ ok: true });\n}\n\nexport async function PATCH(req: NextRequest) {\n  await ensureSchema();\n  const body = await req.json();\n  const { id, status } = body;\n  if (!id || !status) return Response.json({ error: 'missing fields' }, { status: 400 });\n  await sql`UPDATE investment_plans SET status=${status} WHERE id=${id}`;\n  return Response.json({ ok: true });\n}\n"],"names":[],"mappings":"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","debugId":null}}]
}