{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 40, "column": 0}, "map": {"version":3,"sources":["file:///Users/saunmy/Desktop/nextjs1/nextjs1/app/api/funds/%5Bcode%5D/route.ts"],"sourcesContent":["import { NextRequest } from 'next/server';\n\nasync function fetchWithTimeout(url: string, ms: number) {\n  const controller = new AbortController();\n  const id = setTimeout(() => controller.abort(), ms);\n  try {\n    const res = await fetch(url, { cache: 'no-store', signal: controller.signal });\n    if (!res.ok) throw new Error('fetch failed');\n    return await res.json();\n  } finally {\n    clearTimeout(id);\n  }\n}\n\nasync function fetchEastmoneyDetail(code: string) {\n  const url = `http://fund.eastmoney.com/${code}.html`;\n  const res = await fetch(url, { cache: 'no-store' });\n  if (!res.ok) throw new Error('fetch failed');\n  const html = await res.text();\n  const nameMatch = html.match(/<h1.*?>(.*?)<\\/h1>/);\n  const name = nameMatch ? nameMatch[1].trim() : '基金';\n  const typeMatch = html.match(/基金类型：<a[^>]*>(.*?)<\\/a>/);\n  const type = typeMatch ? typeMatch[1].trim() : '';\n  const netMatch = html.match(/单位净值.*?<span.*?>([\\d\\.]+)<\\/span>/);\n  const netWorth = netMatch ? Number(netMatch[1]) : null;\n  const dateMatch = html.match(/净值日期：<span.*?>([\\d\\-]+)<\\/span>/);\n  const netWorthDate = dateMatch ? dateMatch[1] : null;\n  const dayMatch = html.match(/日增长率.*?<span.*?>([-+\\d\\.]+)%<\\/span>/);\n  const dayGrowth = dayMatch ? Number(dayMatch[1]) : 0;\n  return {\n    data: [{ code, name, type, netWorth, netWorthDate, dayGrowth, lastMonthGrowth: 0, lastThreeMonthsGrowth: 0, lastYearGrowth: 0, company: '' }],\n  };\n}\n\nasync function fetchPingzhongData(code: string) {\n  const url = `http://fund.eastmoney.com/pingzhongdata/${code}.js`;\n  const res = await fetch(url, { cache: 'no-store' });\n  if (!res.ok) throw new Error('fetch failed');\n  const js = await res.text();\n  const nameMatch = js.match(/var\\s+fS_name\\s*=\\s*\"([^\"]+)\"/);\n  const typeMatch = js.match(/var\\s+fS_type\\s*=\\s*\"([^\"]+)\"/);\n  const name = nameMatch ? nameMatch[1] : '基金';\n  const type = typeMatch ? typeMatch[1] : '';\n  const trendMatch = js.match(/var\\s+Data_netWorthTrend\\s*=\\s*(\\[[\\s\\S]*?\\]);/);\n  let netWorth: number | null = null;\n  let netWorthDate: string | null = null;\n  let dayGrowth = 0;\n  let lastMonthGrowth = 0;\n  let lastThreeMonthsGrowth = 0;\n  let lastYearGrowth = 0;\n  if (trendMatch) {\n    try {\n      const arr = JSON.parse(trendMatch[1]);\n      if (Array.isArray(arr) && arr.length > 0) {\n        const l = arr.length - 1;\n        const latest = arr[l];\n        netWorth = typeof latest?.y === 'number' ? latest.y : null;\n        netWorthDate = latest?.x ? new Date(latest.x).toISOString().slice(0, 10) : null;\n        if (l > 0 && typeof arr[l - 1]?.y === 'number' && arr[l - 1].y > 0 && netWorth != null) {\n          dayGrowth = Number((((netWorth - arr[l - 1].y) / arr[l - 1].y) * 100).toFixed(2));\n        }\n        const idx1m = Math.max(0, l - 22);\n        const idx3m = Math.max(0, l - 66);\n        const idx1y = Math.max(0, l - 252);\n        if (typeof arr[idx1m]?.y === 'number' && arr[idx1m].y > 0 && netWorth != null) {\n          lastMonthGrowth = Number((((netWorth - arr[idx1m].y) / arr[idx1m].y) * 100).toFixed(2));\n        }\n        if (typeof arr[idx3m]?.y === 'number' && arr[idx3m].y > 0 && netWorth != null) {\n          lastThreeMonthsGrowth = Number((((netWorth - arr[idx3m].y) / arr[idx3m].y) * 100).toFixed(2));\n        }\n        if (typeof arr[idx1y]?.y === 'number' && arr[idx1y].y > 0 && netWorth != null) {\n          lastYearGrowth = Number((((netWorth - arr[idx1y].y) / arr[idx1y].y) * 100).toFixed(2));\n        }\n      }\n    } catch {}\n  }\n  return {\n    data: [{ code, name, type, netWorth, netWorthDate, dayGrowth, lastMonthGrowth, lastThreeMonthsGrowth, lastYearGrowth, company: '' }],\n  };\n}\n\nexport async function GET(req: NextRequest, { params }: { params: Promise<{ code: string }> }) {\n  try {\n    const { code } = await params;\n    const base = process.env.FUND_API_DETAIL_URL || 'https://api.doctorxiong.club/v1/fund?code=';\n    try {\n      const data = await fetchWithTimeout(`${base}${encodeURIComponent(code)}`, 4000);\n      return Response.json(data);\n    } catch {}\n    try {\n      const data = await fetchPingzhongData(code);\n      return Response.json(data);\n    } catch {}\n    const data = await fetchEastmoneyDetail(code);\n    return Response.json(data);\n  } catch (e) {\n    const fallback = {\n      data: [{\n        code: await (await params).code,\n        name: '示例基金',\n        type: '指数',\n        netWorth: null,\n        netWorthDate: null,\n        dayGrowth: 0,\n        lastMonthGrowth: 0,\n        lastThreeMonthsGrowth: 0,\n        lastYearGrowth: 0,\n        company: '示例公司'\n      }]\n    };\n    return Response.json(fallback);\n  }\n}\n"],"names":[],"mappings":"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","debugId":null}}]
}