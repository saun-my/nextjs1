{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 40, "column": 0}, "map": {"version":3,"sources":["file:///Users/saunmy/Desktop/nextjs1/nextjs1/app/api/funds/list/route.ts"],"sourcesContent":["import { NextRequest } from 'next/server';\n\nfunction toList(data: any[]): any[] {\n  return (data || []).map((it: any) => ({\n    code: it.code,\n    name: it.name,\n    net: it.netWorth || it.net || null,\n    dayGrowth: it.dayGrowth || it.expectGrowth || 0,\n    lastUpdate: it.lastUpdate || it.netWorthDate || null,\n    type: it.type || '',\n  }));\n}\n\nasync function fetchWithTimeout(url: string, ms: number) {\n  const controller = new AbortController();\n  const id = setTimeout(() => controller.abort(), ms);\n  try {\n    const res = await fetch(url, { cache: 'no-store', signal: controller.signal });\n    if (!res.ok) throw new Error('fetch failed');\n    return await res.json();\n  } finally {\n    clearTimeout(id);\n  }\n}\n\nasync function fetchEastmoneyRank(pn: number) {\n  const ts = Date.now();\n  const url = `https://fund.eastmoney.com/data/rankhandler.aspx?op=ph&dt=kf&ft=all&rs=&gs=0&sc=zzf&st=desc&qdii=&tabSubtype=,,,,,&pi=1&pn=${pn}&dx=1&v=${ts}`;\n  const res = await fetch(url, { cache: 'no-store' });\n  if (!res.ok) throw new Error('fetch failed');\n  const text = await res.text();\n  const m = text.match(/\\/\\*\\*(.*?)\\*\\*\\/|\\((\\{[\\s\\S]*?\\})\\)/);\n  const payload = m?.[1] || m?.[2] || '';\n  const jsonMatch = payload.match(/\\{[\\s\\S]*\\}/);\n  const raw = jsonMatch ? JSON.parse(jsonMatch[0]) : null;\n  const rows: string[] = raw?.datas || [];\n  const list = rows.map((row: string) => {\n    const parts = row.split(',');\n    return {\n      code: parts[0],\n      name: parts[1],\n      net: null,\n      dayGrowth: Number(parts[7] || 0),\n      lastUpdate: null,\n      type: parts[3] || ''\n    };\n  });\n  return list;\n}\n\nasync function fetchEastmoneyMobile(pageSize: number) {\n  const url = `https://fundmobapi.eastmoney.com/FundMNewApi/FundMNFInfo?appType=ttjj&product=EFund&plat=Iphone&SRC=kf&Sort=desc&FundTypeCode=&PageIndex=1&PageSize=${pageSize}`;\n  const res = await fetch(url, { cache: 'no-store' });\n  if (!res.ok) throw new Error('fetch failed');\n  const json = await res.json();\n  const rows: any[] = json?.Datas || [];\n  return rows.map((it: any) => ({\n    code: it.FCODE,\n    name: it.SHORTNAME,\n    net: it.NAV ? Number(it.NAV) : null,\n    dayGrowth: it.GSZZL ? Number(it.GSZZL) : 0,\n    lastUpdate: it.NAVDATE || null,\n    type: it.FTNAME || ''\n  }));\n}\n\nasync function fetchPingzhongItem(code: string) {\n  const url = `http://fund.eastmoney.com/pingzhongdata/${code}.js`;\n  const res = await fetch(url, { cache: 'no-store' });\n  if (!res.ok) throw new Error('fetch failed');\n  const js = await res.text();\n  const nameMatch = js.match(/var\\s+fS_name\\s*=\\s*\"([^\"]+)\"/);\n  const typeMatch = js.match(/var\\s+fS_type\\s*=\\s*\"([^\"]+)\"/);\n  const name = nameMatch ? nameMatch[1] : code;\n  const type = typeMatch ? typeMatch[1] : '';\n  const trendMatch = js.match(/var\\s+Data_netWorthTrend\\s*=\\s*(\\[[\\s\\S]*?\\]);/);\n  let net: number | null = null;\n  let lastUpdate: string | null = null;\n  let dayGrowth = 0;\n  if (trendMatch) {\n    try {\n      const arr = JSON.parse(trendMatch[1]);\n      if (Array.isArray(arr) && arr.length > 0) {\n        const l = arr.length - 1;\n        const latest = arr[l];\n        net = typeof latest?.y === 'number' ? latest.y : null;\n        lastUpdate = latest?.x ? new Date(latest.x).toISOString().slice(0, 10) : null;\n        if (l > 0 && typeof arr[l - 1]?.y === 'number' && arr[l - 1].y > 0 && net != null) {\n          dayGrowth = Number((((net - arr[l - 1].y) / arr[l - 1].y) * 100).toFixed(2));\n        }\n      }\n    } catch {}\n  }\n  return { code, name, net, dayGrowth, lastUpdate, type };\n}\n\nasync function fetchPingzhongList(codes: string[]) {\n  const results = await Promise.all(\n    codes.map(async (c) => {\n      try {\n        return await fetchPingzhongItem(c);\n      } catch {\n        return { code: c, name: c, net: null, dayGrowth: 0, lastUpdate: null, type: '' };\n      }\n    })\n  );\n  return results;\n}\n\nexport async function GET(req: NextRequest) {\n  try {\n    const listUrl = process.env.FUND_API_LIST_URL || 'https://api.doctorxiong.club/v1/fund/rank';\n    try {\n      const data = await fetchWithTimeout(listUrl, 4000);\n      const list = toList(data?.data || data?.list || []);\n      if (list.length > 0) return Response.json({ list, count: list.length, source: listUrl });\n    } catch {}\n    try {\n      const list = await fetchEastmoneyMobile(50);\n      if (list.length > 0) return Response.json({ list, count: list.length, source: 'eastmoney' });\n    } catch {}\n    const defaultCodes = (process.env.FUND_TOP_CODES || '110022,161725,519732,001632,003095')\n      .split(',')\n      .map((s) => s.trim())\n      .filter(Boolean);\n    try {\n      const list = await fetchPingzhongList(defaultCodes);\n      return Response.json({ list, count: list.length, source: 'pingzhongdata' });\n    } catch {}\n    const fallback = defaultCodes.map((c) => ({ code: c, name: c, net: null, dayGrowth: 0, lastUpdate: null, type: '' }));\n    return Response.json({ list: fallback, count: fallback.length, source: 'fallback' });\n  } catch (e) {\n    const defaultCodes = (process.env.FUND_TOP_CODES || '110022,161725,519732,001632,003095')\n      .split(',')\n      .map((s) => s.trim())\n      .filter(Boolean);\n    const fallback = defaultCodes.map((c) => ({ code: c, name: c, net: null, dayGrowth: 0, lastUpdate: null, type: '' }));\n    return Response.json({ list: fallback, count: fallback.length, source: 'fallback' });\n  }\n}\n"],"names":[],"mappings":"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","debugId":null}}]
}